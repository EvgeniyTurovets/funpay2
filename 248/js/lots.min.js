var Lots={location:"",onOfferEditorButtonClick:function(){var c=$(this);var f=c.closest(".modal");var e=f.find("form");var a=f.find(".js-btn-save");var g=f.find(".js-btn-delete");var b=f.find(".js-btn-delete-cancel");var d=e.find('input[name="deleted"]');if(c.is(g)){if(g.hasClass("confirm")){d.val("1")}else{g.addClass("confirm").attr("data-text-delete",g.text()).text(g.attr("data-text-confirm"));a.addClass("hidden");b.removeClass("hidden");return false}}else{if(c.is(b)){d.val("");g.removeClass("confirm").text(g.attr("data-text-delete"));a.removeClass("hidden");b.addClass("hidden");return false}}return true},processOfferEditorErrors:function(d,f){var e,a,c,b;d.find(".form-group.has-error").each(function(){e=$(this);a=e.find(".help-block");c=a.data("help");if(c){a.html(c)}else{a.addClass("hidden")}e.removeClass("has-error")});if(f){for(b=0;b<f.length;++b){e=d.find('[name="'+f[b][0]+'"]').closest(".form-group");if(e.length){e.addClass("has-error");a=e.find(".help-block");if(!a.length){a=$("<p>",{"class":"help-block"});e.append(a)}if(typeof a.data("help")=="undefined"){a.data("help",a.html())}a.text(f[b][1]).removeClass("hidden")}}}},onOfferEditorSubmit:function(){var b=$(this);var c=b.serializeObject();var a=b.find('input[type="submit"], button[type="submit"]');c.location=Lots.location;a.prop("disabled",true);$.ajax({type:"POST",url:app.processRoute(b.attr("action")),data:c,dataType:"json",error:onAjaxError,success:function(e){if(e.error){showMessage(e.error,true)}var d=b.closest(".modal");if(e.done){d.modal("hide");if(e.url){window.location.href=e.url}else{if(e.content){$("#content").html(e.content)}}}else{Lots.processOfferEditorErrors(b,e.errors);d.modal("handleUpdate")}},complete:function(){a.prop("disabled",false)}});return false},updateLotFields:function(f){if(!f||f.length!=1){return}var a,b,c,g,l,i,j,d;var k={};var e=false;var h=f.data("fields");if(!h||!h.length){return}for(b=0;b<h.length;++b){g=h[b]["id"];l=h[b]["conditions"];i=f.find('.lot-field[data-id="'+g+'"]');j=i.find(".lot-field-input");if(l.length){d=false;for(c=0;c<l.length;++c){a=l[c]["id"];if(k.hasOwnProperty(a)&&l[c]["list"].indexOf(k[a])>=0){d=true;break}}}else{d=true}if(d){k[g]=j.val().toLowerCase()}if(i.hasClass("hidden")==d){e=true}i.toggleClass("hidden",!d);j.prop("disabled",!d)}f.closest(".showcase-filters").trigger("filter.fp.showcase");if(e){f.closest(".modal").modal("handleUpdate")}},onLotFieldChange:function(){var b=$(this);var d=b.closest(".lot-field");var c=b.val();if(d.data("value")===c){return}d.data("value",c);var a=d.closest(".lot-fields");Lots.updateLotFields(a)},updateRangeValue:function(b){var e=b.closest(".lot-field");var c=Number(e.find(".range-min").val())||0;var a=Number(e.find(".range-max").val())||0;var d=c||a?(c?c:"")+":"+(a?a:""):"";b.val(d).data({min:c,max:a})},onLotFieldRangeChange:function(){var a=$(this).closest(".lot-field").find(".range-value");Lots.updateRangeValue(a);a.change()},activateLotFields:function(){var a=$(".lot-fields:not(.live)");if(a.length){a.addClass("live");a.on("change input",".lot-field-input",Lots.onLotFieldChange);a.find(".range-value").each(function(){Lots.updateRangeValue($(this))});a.on("change input",".lot-field-range",Lots.onLotFieldRangeChange)}return a},activatePriceTable:function(b,k){var m=$(".js-calc-table");if(!m.length){return}var g=m.find(".js-calc-table-body");var f=m.closest("form").find('input[name="price"]');var j;var i={};var h=0;function c(){return strToFloat(f.val())}function d(o,n){if(h>=1000){i={};h=0}if(!i[o]){h++}i[o]=n}function l(n){g.html(n);g.removeClass("blur");m.toggleClass("hidden",!n.length);k.modal("handleUpdate")}function e(q){var p=$("<tbody/>");for(var o in q){if(q.hasOwnProperty(o)){var r=q[o];var n=$("<tr/>").append($("<th/>").text(r.name)).append($("<td/>").text(r.price+" "+r.unit));p.append(n)}}return p}function a(n){if(i.hasOwnProperty(n)){l(e(i[n]).html());return}if(g.html().trim().length){g.addClass("blur")}else{l('<span class="text-muted">'+app.t("modal.loading.text")+"</span>")}$.ajax({type:"POST",url:app.processRoute("/lots/calc"),data:{nodeId:b,price:n},dataType:"json",error:onAjaxErrorCallback(function(){if(c()===n){l('<span class="text-danger">'+app.t("request.fail.error")+"</span>")}}),success:function(p){var o=p.error||false;if(!o){p.methods.sort(function(r,q){return r.pos-q.pos});d(n,p.methods)}if(c()!==n){return}if(o){l($("<span/>",{"class":"text-danger"}).text(o))}else{l(e(i[n]).html())}}})}f.on("input",function(){clearTimeout(j);j=setTimeout(function(){var n=c();if(n>0){a(n)}else{l("")}},500)})},openOfferEditor:function(c,f){var e=getModal("modal-offer-editor",{title:app.t(c?"lot.modal.edit.title":"lot.modal.add.title")});var b=e.find(".modal-body");function d(g){if(!g){return}if(!b.hasClass("shown")){b.data("buffer",g);return}b.empty().append(g);e.modal("handleUpdate");e.scrollTop(0);Lots.activateLotFields();Lots.activatePriceTable(f,e)}if(!e.hasClass("live")){e.addClass("live");e.on("submit","form",Lots.onOfferEditorSubmit);e.on("click","button",Lots.onOfferEditorButtonClick);e.on("shown.bs.modal",function(){b.addClass("shown");d(b.data("buffer"))})}b.removeData("buffer").removeClass("shown");b.html('<span class="text-muted">'+app.t("modal.loading.text")+"</span>");e.modal("show");var a=getRandomTag();e.attr("data-tag",a);$.ajax({type:"GET",url:app.processRoute("/lots/offerEdit"),data:{offer:c,node:f,tag:a},dataType:"json",error:function(){if(e.attr("data-tag")!=a){return}var g=getAjaxError.apply(this,arguments);d($("<span>",{"class":"text-danger"}).text(g))},success:function(g){if(e.attr("data-tag")!=a){return}d(g.html)}})},raiseOffers:function(d,e,c){function b(f){f.find(".js-lot-raise-ex").click(function(){var i=$(this).closest(".raise-box");var h=i.data("game");var j=i.data("node");var g=[];i.find('input[type="checkbox"]').each(function(){if(this.checked){g.push(this.value)}});Lots.raiseOffers.apply(this,[h,j,g])})}var a=$(this);a.prop("disabled",true);$.ajax({type:"POST",url:app.processRoute("/lots/raise"),data:{game_id:d,node_id:e,node_ids:c},dataType:"json",error:onAjaxError,success:function(h){if(h.msg){showMessage(h.msg,h.error)}var f="modal-raise-nodes";if(h.modal){var g=getModal(f,{title:app.t("lot.categories.modal.title"),size:"sm"});g.find(".modal-body").html(h.modal);b(g);g.modal("handleUpdate");g.modal("show")}else{if(!h.error){$("."+f).modal("hide")}}},complete:function(){a.prop("disabled",false)}});return false}};$(function(){var b=$("#content");b.on("click",".js-lot-offer-edit",function(){var c=$(this);Lots.openOfferEditor(c.attr("data-offer"),c.attr("data-node"))});if(b.hasClass("content-lots-trade")){Lots.location="trade";b.on("click",".showcase-table .tc-item",function(){var c=$(this);Lots.openOfferEditor(c.data("offer"),c.data("node"));return false});b.on("click",".js-lot-raise",function(){var c=$(this);Lots.raiseOffers.apply(this,[c.data("game"),c.data("node")])})}if(b.hasClass("content-lots-node")){var a=Lots.activateLotFields();a.each(function(){Lots.updateLotFields($(this))})}if(b.hasClass("content-lots-offer")){Lots.location="offer"}});